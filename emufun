#!/bin/bash

# wrapper script for the EmuFun frontend.
# This is the part that repeatedly launches EmuFun, passing it a list of
# games detected in the game directory.
# If called without arguments, it runs EmuFun *once* and then exits - this
# is useful for testing. If called with any arguments (doesn't matter what they
# are), it runs forever.

cd "$(dirname $0)"

touch ~/.emufun
source ~/.emufun

[[ $GAMEDIR ]] || GAMEDIR="$HOME/Games"

while true; do
    qjoypad "EmuFun" &
    (cd "$GAMEDIR" && find * -type f) | love . | {
        read CFG
        read ROM
	echo "Launching $ROM using $CFG"
        env \
            ROM="$GAMEDIR/$ROM" \
            CFG="$GAMEDIR/$CFG" \
            GAMEDIR="$GAMEDIR" \
            sh "$GAMEDIR/$CFG"
    }
    [[ $1 ]] || exit
done
